---
title: "Comparing Methods"
---

# Prepare environment

Packages

```{r}
library(tidyverse)
library(plotly)
library(googledrive)
library(readxl)
library(phyloseq)
library(ggVennDiagram)
library(UpSetR)
library(eulerr)
library(ggupset)
source("Code/Import_datasets.R")
'%!in%' <- function(x,y)!('%in%'(x,y))
```

Download nessecery data and update from google drive:
```{r}
# Confirm authorisation
drive_auth()

# Update datasets
update_DNA_datasets()
update_ZP_datasets()
update_Contributed_data()

```

# 1. Import and combine Sequence datasets

## COI data components
```{r}

# Import downloaded rds files
ASV_COI <- readRDS("Data_import/COI/ASV_COI.rds")
Samptab_COI <- readRDS("Data_import/COI/Samptab_COI.rds")
Taxtab_COI <- readRDS("Data_import/COI/Taxtab_COI.rds")

# Combine data components to data frame
df_COI <- 
  Taxtab_COI %>%
  full_join(ASV_COI, by = "ASV") %>%
  pivot_longer(!1:12, names_to = "Library_ID", values_to = "Abundance") %>%
  full_join(Samptab_COI, by = "Library_ID")
```

## 18S data components

```{r}

# Import downloaded rds files
ASV_18S <- readRDS("Data_import/18S/ASV_18S.rds")
Samptab_18S <- readRDS("Data_import/18S/Samptab_18S.rds")
Taxtab_18S <- readRDS("Data_import/18S/Taxtab_18S.rds")

# Combine data components to data frame
df_18S <- 
  Taxtab_18S %>%
  full_join(ASV_18S, by = "Sequence") %>% 
  pivot_longer(!1:10, names_to = "Library_ID", values_to = "Abundance") %>% 
  full_join(Samptab_18S, by = "Library_ID") %>% 
  filter(is.na(ASV)==FALSE)
```
## 18S Time series contributed

```{r}
df_18S_ts <- readRDS("Data_import/Contributed18S/ps_18S.rds") %>% psmelt()
```



## Microscopy data

```{r}
df_count_vertical <- read_excel("Data_import/Microscopy/Vertical_ZP_2022.xlsx")

df_count_2017 <- readRDS("Data_import/Microscopy/Hakai_Zooplankton_2013-2017_AN.rds") %>% 
  mutate(Name = Taxon) %>% 
  separate(Taxon, sep= " ", into=c("Genus", "Tax1", "Tax2", "Tax3", "Tax4"))
```


Specifying global filterine parameter:
What phyla are present in Metazoa?
```{r}
metazoa <- c("Arthropoda",
             "Cnidaria",
             "Chaetognatha",
             "Annelida",
             "Porifera",
             "Echinodermata",
             "Mollusca",
             "Phoronida",
             "Bryozoa",
             "Nemertea",
             "Ctenophora",
             "Priapulida",
             "Rotifera",
             "Chordata",
             "Platyhelminthes")
```

# 2. Subset and calculate eDNA indexes of datasets:

```{r}

collapseRAindex <- function(data) {
  
  output <- data %>%
    
    # Collapse dataset per date, depth and taxa.
    mutate(Abundance = ifelse(is.na(Abundance), 0, Abundance)) %>% 
    group_by(Date, Taxa, Depth) %>% 
    summarise(Abundance = sum(Abundance)) %>% 
    
    # Calculate relative abundance
    group_by(Date, Depth) %>% 
    reframe(RA = Abundance/sum(Abundance),
            Taxa, Abundance) %>%
    filter(is.na(RA) == FALSE) %>% 
    
    #Calculate Index
    group_by(Taxa) %>%
    reframe(Date, Depth, Abundance, RA,
            RA_Index = RA/max(RA)) %>% 
    filter(is.na(RA_Index) == FALSE)

  return(output)
}


# To be piped into

getSpeciesList <- function(data, type = "DNA") {
  
    if (type == "DNA") {
    data <- data %>% 
      filter(Abundance > 50)
  }
  
  speciesList <- data %>% 
  
    # Remove low occurrences
    filter(RA_Index > 0) %>% 
    group_by(Taxa) %>%
    filter(n() > 2) %>% 
    
    # Remove bad species names
    filter(!grepl('sp.', Taxa),
           !grepl('_sp', Taxa),
           !grepl(' sp', Taxa),
           grepl(' ', Taxa),
           is.na(Taxa)==FALSE,
           Taxa != "no identification") %>% 
  mutate(Taxa = ifelse(Taxa== "Discoconchoecia aff. elegans CMARA05309_Os109.1.1",
                          "Discoconchoecia elegans", Taxa)) %>% 
  
    # Get Taxa names
    pull(Taxa) %>% unique()

  return(speciesList)  
  
  
}

getGenusList <- function(data, type="DNA") {
  
  if (type == "DNA") {
    data <- data %>% 
      filter(Abundance > 50)
  }
  
  speciesList <- data %>%
  
    # Remove low occurrences
    filter(RA_Index > 0) %>% 
    group_by(Taxa) %>%
    filter(n() > 2) %>%
    
    # Remove bad genus names
    filter(is.na(Taxa)==FALSE,
           !grepl('_', Taxa),
           Taxa != "no identification",
           Taxa != "unknown genus") %>% 
    # Get Taxa names
    pull(Taxa) %>% unique()

  return(speciesList)  
  
  
}


  
```


### Net Microscopy
```{r}

Net_count_2017 <- df_count_2017 %>% 
  # Subset data
  filter(Station %in% c("QU39"),
         year(Date) == 2017)
  

# Species level   
Net_count_2017_index_species <- Net_count_2017 %>% 
  # Define Taxa, abundance, Depth Date:
  mutate(Taxa = paste(Genus, Tax1, sep = " "),
         Abundance = Biomass,
         Depth= DEPTH_STRT,
         Date = Date) %>% 
  # Calculate RA index
  collapseRAindex()


# Genus level
Net_count_2017_index_genus <- Net_count_2017 %>% 
  # Define Taxa, abundance, Depth Date:
  mutate(Taxa = Genus,
         Abundance = Biomass,
         Depth= DEPTH_STRT,
         Date = Date) %>% 
  # Calculate RA index
  collapseRAindex()

# Print levels
Net_count_2017_index_species %>% 
  getSpeciesList(type="m")
  
Net_count_2017_index_genus %>% 
  getGenusList(type="m")

```


### Net 18S
```{r}
Net_18S_2017 <- df_18S %>% 
  #Subset
  filter(Project_name == "Vertical",
         year(Sample_date) == 2017,
         Division == "Metazoa",
         Sample_type == "Zp_Net")

# Species level  
Net_18S_2017_index_species <- Net_18S_2017 %>% 
  # Define Taxa, abundance, Depth Date:
  mutate(Taxa = str_replace(Species, "_", " "),
         Abundance = Abundance,
         Depth = Line_out_depth,
         Date = Sample_date) %>% 
  collapseRAindex()
  

# Genus level  
Net_18S_2017_index_genus <- Net_18S_2017 %>% 
  # Define Taxa, abundance, Depth Date:
  mutate(Taxa = Genus,
         Abundance = Abundance,
         Depth=Line_out_depth,
         Date = Sample_date) %>% 
  collapseRAindex()

Net_18S_2017_index_species
# Print levels
Net_18S_2017_index_species %>%
  getSpeciesList()

Net_18S_2017_index_genus %>%
  getGenusList()

```
### eDNA 18S
```{r}
eDNA_18S_2017 <- df_18S_ts %>% 
  #Subset
  filter(year(collected) == 2017,
         site_id == "QU39",
         Kingdom == "Metazoa")

# Species level index
eDNA_18S_2017_index_species <- eDNA_18S_2017 %>% 
  mutate(Taxa = str_replace(Species, "_", " "),
         Abundance = Abundance,
         Depth = line_out_depth,
         Date = date(collected)) %>% 
  collapseRAindex()

# Genus level index
eDNA_18S_2017_index_genus <- eDNA_18S_2017 %>% 
  mutate(Taxa = Genus,
         Abundance = Abundance,
         Depth = line_out_depth,
         Date = date(collected)) %>% 
  collapseRAindex()


# Print levels  
eDNA_18S_2017_index_species %>% 
  getSpeciesList()

eDNA_18S_2017_index_genus %>% 
  getGenusList()

```

### Net COI

```{r}
Net_COI_2017 <- df_COI %>%
  #Subset
  filter(Project_name == "Vertical",
         year(Sample_date) == 2017,
         Sample_type == "Zp_Net",
         phylum %in% metazoa)

# Species level index
Net_COI_2017_index_species <- Net_COI_2017 %>% 
  mutate(Taxa = species,
         Abundance = Abundance,
         Depth = Line_out_depth,
         Date = Sample_date) %>% 
  collapseRAindex()

# Species level index
Net_COI_2017_index_genus <- Net_COI_2017 %>% 
  mutate(Taxa = genus,
         Abundance = Abundance,
         Depth = Line_out_depth,
         Date = Sample_date) %>% 
  collapseRAindex()

# Print levels
Net_COI_2017_index_species %>% 
  getSpeciesList()

Net_COI_2017_index_genus %>% 
  getGenusList()
  

```

### eDNA COI

```{r}
eDNA_COI_2017 <- df_COI %>%
  #Subset
  filter(Project_name == "QU39",
         Sample_type == "eDNA",
         year(Sample_date)==2017,
         phylum %in% metazoa)

# Species level index
eDNA_COI_2017_index_species <- eDNA_COI_2017 %>% 
  mutate(Taxa = species,
         Abundance = Abundance,
         Depth = Line_out_depth,
         Date = Sample_date) %>% 
  collapseRAindex()

# Species level index
eDNA_COI_2017_index_genus <- eDNA_COI_2017 %>% 
  mutate(Taxa = genus,
         Abundance = Abundance,
         Depth = Line_out_depth,
         Date = Sample_date) %>% 
  collapseRAindex()


# Print levels
eDNA_COI_2017_index_species %>% 
  getSpeciesList()

eDNA_COI_2017_index_genus %>% 
  getGenusList()
  

```

# 3. Taxomonic coverate upset comparison

## Species level

```{r}

SpeciesListComp <- list(
  `Net Microscopy` = getSpeciesList(Net_count_2017_index_species, type = "m"),
  `Net 18S` = getSpeciesList(Net_18S_2017_index_species),
  `Net COI` = getSpeciesList(Net_COI_2017_index_species),
  `eDNA COI` = getSpeciesList(eDNA_COI_2017_index_species),
  `eDNA 18S` = getSpeciesList(eDNA_18S_2017_index_species)
)

upset(fromList(SpeciesListComp),
      sets = c("Net Microscopy", "Net 18S", "Net COI", "eDNA 18S", "eDNA COI"))
```

## Genus Level

```{r}
GenusListComp <- list(
  `Net Microscopy` = getGenusList(Net_count_2017_index_genus, type = "m"),
  `Net 18S` = getGenusList(Net_18S_2017_index_genus),
  `Net COI` = getGenusList(Net_COI_2017_index_genus),
  `eDNA COI` = getGenusList(eDNA_COI_2017_index_genus),
  `eDNA 18S` = getGenusList(eDNA_18S_2017_index_genus)
)

upset(fromList(GenusListComp),
      sets = c("Net Microscopy", "Net 18S", "Net COI", "eDNA COI", "eDNA 18S"))
```
Plot Euler diagrams
```{r}
pdf("Figure_output/Euler_species.pdf")
par(mfcol = c(1,2))
set.seed(104)
SpeciesListComp %>% 
  fromList() %>% 
  euler(shape = "ellipse") %>% 
  plot(quantities = TRUE,
       fill = "transparent",
        lty = 1:5)

set.seed(102)
GenusListComp %>% 
  fromList() %>% 
  euler(shape = "ellipse") %>% 
  plot(quantities = TRUE,
       fill = "transparent",
       lty = 1:5)

dev.off()
```




```{r}

{ ## Genus level biomass comparison ##
Sum_per_species <- Net_count_2017_index_species %>% 
  filter(Taxa %in% getSpeciesList(Net_count_2017_index_species, type = "m")) %>% 
  group_by(Taxa, Date) %>% 
  summarize(Biomass = sum(Abundance))

Sum_per_day <- Sum_per_species %>%
  group_by(Date) %>% 
  summarize(Counted_Biomass = sum(Biomass))

Detected_COI <- Sum_per_species %>% 
  filter(Taxa %in% getSpeciesList(Net_COI_2017_index_species)) %>% 
  group_by(Date) %>% 
  summarize(Detected_COI = sum(Biomass)) %>% 
  left_join(Sum_per_day, by = "Date")

Detected_18S <- Sum_per_species %>% 
  filter(Taxa %in% getSpeciesList(Net_18S_2017_index_species)) %>% 
  group_by(Date) %>% 
  summarize(Detected_18S = sum(Biomass)) %>% 
  left_join(Detected_COI, by = "Date")

Sum_per_day_all <- Sum_per_species %>% 
  filter(Taxa %in% c(getSpeciesList(Net_18S_2017_index_species),
                     getSpeciesList(Net_COI_2017_index_species))) %>% 
  group_by(Date) %>%
  summarize(Detected_18S_COI = sum(Biomass)) %>% 
  left_join(Detected_18S, by = "Date")

#Plot yearly average
fraction_species <- 
  Sum_per_day_all %>% 
  mutate(Net_COI = Detected_COI / Counted_Biomass,
         Net_18S = Detected_18S / Counted_Biomass,
         Net_COI_and_18S = Detected_18S_COI /Counted_Biomass) %>% 
  select(Date, Net_COI, Net_18S, Net_COI_and_18S) %>% 
  pivot_longer(2:4, names_to = "Marker", values_to = "Proportion") %>% 
  mutate(Level = "Species level")}


{ ##Species level biomass comparison##
Sum_per_genus <- Net_count_2017_index_genus %>% 
  filter(Taxa %in% getGenusList(Net_count_2017_index_genus, type = "m")) %>% 
  group_by(Taxa, Date) %>% 
  summarize(Biomass = sum(Abundance))

Sum_per_day <- Sum_per_genus %>%
  group_by(Date) %>% 
  summarize(Counted_Biomass = sum(Biomass))

Detected_COI <- Sum_per_genus %>% 
  filter(Taxa %in% getGenusList(Net_COI_2017_index_genus)) %>% 
  group_by(Date) %>% 
  summarize(Detected_COI = sum(Biomass)) %>% 
  left_join(Sum_per_day, by = "Date")
  
Detected_18S <- Sum_per_genus %>% 
  filter(Taxa %in% getGenusList(Net_18S_2017_index_genus)) %>% 
  group_by(Date) %>% 
  summarize(Detected_18S = sum(Biomass)) %>% 
  left_join(Detected_COI, by = "Date")

Sum_per_day_all <- Sum_per_genus %>% 
  filter(Taxa %in% c(getGenusList(Net_18S_2017_index_genus),
                     getGenusList(Net_COI_2017_index_genus))) %>% 
  group_by(Date) %>%
  summarize(Detected_18S_COI = sum(Biomass)) %>% 
  left_join(Detected_18S, by = "Date")

fraction_genus <-   
  Sum_per_day_all %>% 
  mutate(Net_COI = Detected_COI / Counted_Biomass,
         Net_18S = Detected_18S / Counted_Biomass,
         Net_COI_and_18S = Detected_18S_COI /Counted_Biomass) %>% 
  select(Date, Net_COI, Net_18S, Net_COI_and_18S) %>% 
  pivot_longer(2:4, names_to = "Marker", values_to = "Proportion") %>% 
  mutate(Level = "Genus level")}


# Combine and plot
bind_rows(fraction_genus, fraction_species) %>%
  mutate(Level = factor(Level, levels = c("Species level", "Genus level"))) %>% 
  ggplot(aes(Marker, Proportion)) +
  geom_violin() +
  theme_bw() +
  facet_wrap("Level")
  
ggsave("Figure_output/Biomass_fractions.pdf")
```

## Exclusions:

Net counted zooplankton biomass; not targeted by molecular markers, ordered by biomass 
```{r}

Net_count_2017_index_genus %>% 
  filter(Taxa %in% getGenusList(Net_count_2017_index_genus, type = "m"),
         Taxa %!in% getGenusList(Net_18S_2017_index_genus),
         Taxa %!in% getGenusList(Net_COI_2017_index_genus)) %>% 
  group_by(Taxa, Date) %>% 
  summarize(Biomass = sum(Abundance)) %>% 
  group_by(Taxa) %>% 
  summarize(Biomass = mean(Biomass)) %>%
    reframe(Biomass = Biomass/sum(Biomass),
          Taxa) %>%
  ggplot() +
  geom_bar(aes(reorder(Taxa, -Biomass), Biomass), stat = "identity") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```
Taxa identified by eDNA COI, not present in the Net ZP counts, sorted by Relative read abundance
```{r}

eDNA_COI_2017_index_genus %>% 
  filter(Taxa %in% getGenusList(eDNA_COI_2017_index_genus),
         Taxa %!in% getGenusList(Net_count_2017_index_genus, type = "m")) %>% 
  group_by(Taxa) %>% 
  summarize(RA = mean(RA)) %>% 
  ggplot() +
  geom_bar(aes(reorder(Taxa, -RA), RA), stat = "identity") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```
Taxa identified by eDNA 18S, not present in the Net ZP counts, sorted by Relative read abundance
```{r}

eDNA_18S_2017_index_genus %>% 
  filter(Taxa %in% getGenusList(eDNA_18S_2017_index_genus),
         Taxa %!in% getGenusList(Net_count_2017_index_genus, type = "m")) %>% 
  group_by(Taxa) %>% 
  summarize(RA = mean(RA)) %>% 
  ggplot() +
  geom_bar(aes(reorder(Taxa, -RA), RA), stat = "identity") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```


## Conclusions:

1. 18S Cannot be used to identify taxa at species level, the gene is to conserved.
2. COI Covers around 38-75% of the ZP-net biomass at the specie level.
3. All markers have higher agreement on the genus level, but COI still outperforms 18S also at the genus level.
4. Combining 18S and COI is slightly, but only marginally better than using COI alone.

5. Out of the biomass not detected by the molecular markers, larger taxa, such as amphipods, has the highest biomass.
6. eDNA of COI and 18S catches many different metazooan taxa not targeted by microscopy. Most of these taxa are benthic mollusks, worms, echinoderms or cnidarians.


# 4. Temporal Comparaison

Construct lists of genera with overlapping data from Microscopy and any of the molecular markers:
```{r}
GenusList <-
  Net_count_2017_index_genus %>% 
  filter(Taxa %in% getGenusList(., "m"),
         Taxa %in% c(getGenusList(Net_18S_2017_index_genus),
                     getGenusList(Net_COI_2017_index_genus),
                     getGenusList(eDNA_18S_2017_index_genus),
                     getGenusList(eDNA_COI_2017_index_genus))) %>% 
  pull(Taxa) %>% unique()

SpeciesList <-
  Net_count_2017_index_species %>% 
  filter(Taxa %in% getSpeciesList(., "m"),
         Taxa %in% c(getSpeciesList(Net_COI_2017_index_species),
                     getSpeciesList(eDNA_COI_2017_index_species))) %>% 
  pull(Taxa) %>% unique()

GenusList
SpeciesList
```



## Genus Level

ZP Net
```{r}

bind_rows(mutate(Net_count_2017_index_genus, marker = "Count"),
          mutate(Net_COI_2017_index_genus, marker = "COI"),
          mutate(Net_18S_2017_index_genus, marker = "18S")) %>% 
  filter(Taxa %in% GenusList) %>%
  ggplot() +
  geom_line(aes(Date, RA_Index, color = marker)) +
  facet_wrap(facets = "Taxa") +
  theme_bw() +
  labs(title = "Integrated Zooplankton Nets Genus Level") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

ggsave("Figure_output/Seasonal_Net_Genus_Comp.pdf")
```

eDNA (18S and COI Combined)
```{r}

bind_rows(mutate(eDNA_COI_2017_index_genus, marker = "COI"),
          mutate(eDNA_18S_2017_index_genus, marker = "18S",
                 Depth = as.character(Depth))) %>% 
  filter(Taxa %in% GenusList) %>% 
  group_by(Taxa, Date, Depth) %>% 
  summarize(RA_Index = mean(RA_Index),
            Abundance = mean(Abundance)) %>%
  mutate(Depth = factor(Depth, levels = rev(c("0", "5", "30", "100", "260")))) %>% 
  ggplot() +
  
  geom_point(aes(Date, Depth,
                 color = RA_Index, size = RA_Index, alpha = RA_Index)) +
  facet_wrap(facets = "Taxa") +
  theme_bw() +
  theme_bw() +
  scale_color_viridis_b() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(title = "eDNA Vertical at Genus Level")

ggsave("Figure_output/Seasonal_eDNA_Genus_Comp.pdf")
```

## Species Level
```{r}

bind_rows(mutate(Net_count_2017_index_species, marker = "Count"),
          mutate(Net_COI_2017_index_species, marker = "COI")) %>% 
  filter(Taxa %in% SpeciesList) %>%
  ggplot() +
  geom_line(aes(Date, RA_Index, color = marker)) +
  facet_wrap(facets = "Taxa") +
  theme_bw() +
  labs(title = "Integrated Zooplankton Nets Species Level") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

ggsave("Figure_output/Seasonal_Net_Species_Comp.pdf")
```



eDNA (COI only)
```{r}

eDNA_COI_2017_index_species %>% 
  filter(Taxa %in% SpeciesList) %>% 
  group_by(Taxa, Date, Depth) %>% 
  mutate(Depth = factor(Depth, levels = rev(c("0", "5", "30", "100", "260")))) %>% 
  ggplot() +
  
  geom_point(aes(Date, Depth,
                 color = RA_Index, size = RA_Index, alpha = RA_Index)) +
  facet_wrap(facets = "Taxa") +
  theme_bw() +
  theme_bw() +
  scale_color_viridis_b() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(title = "eDNA Vertical at Genus Level")

ggsave("Figure_output/Seasonal_eDNA_Species_Comp.pdf")
```

## Plot correlations

```{r}
bind_rows(mutate(Net_count_2017_index_genus, marker = "Count"),
            mutate(Net_COI_2017_index_genus, marker = "COI"),
            mutate(Net_18S_2017_index_genus, marker = "18S")) %>% 
  filter(Taxa %in% GenusList)
  
  Net_count_2017_index_genus
  
  left_join(
    Net_count_2017_index_genus,
    Net_COI_2017_index_genus,
    by = c("Taxa", "Date"),
    suffix = c(".count", ".COI")) %>%
  filter(Taxa %in% GenusList) %>% 
  ggplot(aes(RA_Index.count, RA_Index.COI)) +
  geom_point() +
  geom_smooth(method = lm) +
  facet_wrap(facets = "Taxa") +
  theme_bw() +
  ylim(0, 1)
  
dat <- left_join(
    Net_count_2017_index_genus,
    Net_COI_2017_index_genus,
    by = c("Taxa", "Date"),
    suffix = c(".count", ".COI")) %>%
  filter(Taxa %in% GenusList)

lm()
```





# ##### TO CLEANUP #####


# Vertical Comparaison eDNA index

## Zooplankton net samples:

### Microscopy

```{r}
  
net_microscopy_index <-
  df_count_vertical %>% 
  mutate(Abundance=Count*Fraction) %>%
  
  # Summarise all Genus counts per
  group_by(StationID, Depth, SampleID, Genus) %>% 
  summarise(Abundance = sum(Abundance)) %>%
  
  # Fill zero counts
  pivot_wider(names_from = Genus,
              values_from = Abundance,
              values_fill = 0) %>% 
  pivot_longer(4:11, names_to = "Genus", values_to = "Abundance") %>% 
  
  # Calculate relative abundance
  group_by(StationID, Depth) %>% 
  reframe(Abundance = Abundance/sum(Abundance),
            Genus) %>% 
  
  # Calculate Index
  group_by(Genus) %>% 
  reframe(eDNA_index = Abundance/max(Abundance),
          Site_ID = StationID, Line_out_depth = Depth) %>% 
  mutate(Marker = "Microscopy")

net_microscopy_index
  
```


```{r}
counted_taxa_vertical <-
  net_microscopy_index %>% 
  pull(Genus) %>% 
  unique()

counted_taxa_vertical
```



### 18S

```{r}

Net_18S_index <-
  df_18S %>% 
  filter(Project_name == "Vertical",
         year(Sample_date) == 2022,
         Division == "Metazoa",
         Sample_type == "Zp_Net",
         is.na(Genus) == FALSE,
         Genus %in% counted_taxa_vertical) %>% 
  
  #sum over genus and remove low counts
  group_by(Genus, Line_out_depth, Site_ID) %>% 
  summarise(Abundance = sum(Abundance)) %>%
  group_by(Genus) %>% 
  filter(sum(Abundance) > 100) %>% 
  
  #relative abundance
  group_by(Line_out_depth, Site_ID) %>% 
  reframe(relative_abundance = Abundance / sum(Abundance, na.rm = TRUE),
          Genus) %>%  
  #eDNA index
  group_by(Genus) %>% 
  reframe(eDNA_index = relative_abundance/max(relative_abundance),
          Line_out_depth, Site_ID) %>%
  filter(is.na(eDNA_index) == FALSE) %>% 
  
  mutate(Line_out_depth = factor(Line_out_depth, levels = c(
    "80-0", "120-80", "200-120"))) %>% 
  mutate(Marker = "18S")

Net_18S_index
```

### COI

```{r}
Net_COI_index <- 
  df_COI %>%
  filter(Project_name == "Vertical",
         year(Sample_date) == 2022,
         phylum %in% metazoa,
         Sample_type == "Zp_Net",
         is.na(genus) == FALSE,
         genus %in% counted_taxa_vertical) %>%
  
  #sum over genus and remove low counts
  group_by(genus, Line_out_depth, Site_ID) %>% 
  summarise(Abundance = sum(Abundance)) %>%
  group_by(genus) %>% 
  filter(sum(Abundance) > 100) %>% 
  
  #relative abundance
  group_by(Line_out_depth, Site_ID) %>% 
  reframe(relative_abundance = Abundance / sum(Abundance, na.rm = TRUE),
          genus) %>%  
  #eDNA index
  group_by(genus) %>% 
  reframe(eDNA_index = relative_abundance/max(relative_abundance),
          Line_out_depth, Site_ID) %>%
  filter(is.na(eDNA_index) == FALSE) %>%
  
  mutate(Line_out_depth = factor(Line_out_depth, levels = c(
    "80-0", "120-80", "200-120")),
    Genus = genus,
    Marker = "COI") %>% 
  select(!genus)

Net_COI_index
```




### Combine and plot:

```{r}
comp_plot <-
  bind_rows(Net_COI_index, Net_18S_index, net_microscopy_index) %>%
  mutate(RA_Index = eDNA_index,
         Depth = factor(Line_out_depth, levels = c(
           "200-120", "120-80", "80-0"))) %>%
  ggplot() +
  geom_point(aes(RA_Index, Depth, shape = Site_ID, color = Marker)) +
  stat_summary(aes(RA_Index, Depth, color = Marker, group = Marker),
               fun=mean, geom="line") +
  facet_wrap(facets = "Genus") +
  theme_bw() +
  labs(title = "Zooplankton Net Samples - Vertical")

comp_plot
ggsave("Figure_output/ZPnet_Vertical.pdf")
```

## eDNA Samples

### 18S

```{r}
eDNA_18S_index <- 
df_18S %>% 
  filter(Project_name == "Vertical",
         year(Sample_date) == 2022,
         Division == "Metazoa",
         Sample_type == "eDNA",
         is.na(Genus) == FALSE) %>% 
  
  #sum over genus and remove low counts
  group_by(Genus, Line_out_depth, Site_ID) %>% 
  summarise(Abundance = sum(Abundance)) %>%
  group_by(Genus) %>% 
  filter(sum(Abundance) > 100) %>% 
  
  #relative abundance
  group_by(Line_out_depth, Site_ID) %>% 
  reframe(relative_abundance = Abundance / sum(Abundance, na.rm = TRUE),
          Genus) %>%  
  
  #eDNA index
  group_by(Genus) %>% 
  reframe(eDNA_index = relative_abundance/max(relative_abundance),
          Line_out_depth, Site_ID) %>%
  filter(is.na(eDNA_index) == FALSE) %>% 
  mutate(Line_out_depth = as.integer(Line_out_depth),
         Marker = "18S")

eDNA_18S_index
```

### COI

```{r}
eDNA_COI_index <- 
  df_COI %>%
  filter(Project_name == "Vertical",
         year(Sample_date) == 2022,
         phylum %in% metazoa,
         Sample_type == "eDNA",
         is.na(genus) == FALSE) %>%
  
  #sum over genus and remove low counts
  group_by(genus, Line_out_depth, Site_ID) %>% 
  summarise(Abundance = sum(Abundance)) %>%
  group_by(genus) %>% 
  filter(sum(Abundance) > 100) %>% 
  
  #relative abundance
  group_by(Line_out_depth, Site_ID) %>% 
  reframe(relative_abundance = Abundance / sum(Abundance, na.rm = TRUE),
          genus) %>%  
  #eDNA index
  group_by(genus) %>% 
  reframe(eDNA_index = relative_abundance/max(relative_abundance),
          Line_out_depth, Site_ID) %>%
  filter(is.na(eDNA_index) == FALSE) %>% 
  
  mutate(Line_out_depth = as.integer(Line_out_depth),
         Marker = "COI",
         Genus = genus) %>% 
  select(!genus)

eDNA_COI_index

```

### Combine and Plot

```{r}
eDNA_plot <- bind_rows(eDNA_COI_index, eDNA_18S_index) %>%
  ggplot() +
  geom_point(aes(Line_out_depth, eDNA_index, shape = Site_ID, color = Marker)) +
  stat_summary(aes(Line_out_depth, eDNA_index, color = Marker, group = Marker),
               fun=mean, geom="line") +
  facet_wrap(facets = "Genus") +
  theme_bw() +
  labs(title = "eDNA samples")

eDNA_plot
ggsave("Figure_output/eDNA_vertical.pdf")
```





